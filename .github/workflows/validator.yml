name: Localization Validator

on:
  pull_request:
    branches: [ "main", "develop", "action" ]
    paths:
      - '**.json'

jobs:
  list-locals:
    name: Set matrix of locals files
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      # Getting PR repository
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: set-matrix 
        shell: bash
        run: |
          # Fetch the base branch of the PR to compare changes (using || true to avoid errors)
          git fetch origin "${{ github.base_ref }}" || true

          # Get changed or added locals in the PR
          changed=$(git diff --name-only --diff-filter=AM origin/${{ github.base_ref }}...HEAD || true)

          # Filter only locals files in root directory (e.g. scavgame-locale) and exclude EN.json
          files=$(printf '%s\n' "$changed" | grep '\.json$' || true) 
          files=$(printf '%s\n' "$files" | grep -v -E '(^|/)EN.json$' || true)

          # Output matrix as JSON array
          if [ -z "$files" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            json=$(printf '%s\n' "$files" | python3 -c "import sys,json; print(json.dumps([l.strip()for l in sys.stdin if l.strip()]))")
            echo "matrix=$json" >> $GITHUB_OUTPUT
          fi

  validate:
    needs: list-locals
    if: ${{ needs.list-locals.outputs.matrix != '[]' && needs.list-locals.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.list-locals.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: Validate ${{ matrix.file }}
        # Run the validator project with the locale file as argument
        run: dotnet run --project validator/validator.csproj -- "${{ matrix.file }}"